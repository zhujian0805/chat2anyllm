services:
  # PostgreSQL database for LiteLLM
  postgres:
    build:
      context: .
      dockerfile: Dockerfile.postgres
    container_name: litellm-postgres
    env_file:
      - .env.postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - litellm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U litellm -d litellm"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis cache for LiteLLM
  redis:
    build:
      context: .
      dockerfile: Dockerfile.redis
    container_name: litellm-redis
    networks:
      - litellm-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # LiteLLM proxy server (now exposed on host 4141)
  litellm:
    image: ${LITELLM_IMAGE}
    container_name: litellm-proxy
    ports:
      - "4141:4141"  # Expose LiteLLM directly on host for local access
    volumes:
      - ./config.yaml:/app/config.yaml # Mount the local configuration file
      - /home/jzhu/.config/litellm/github_copilot/:/root/.config/litellm/github_copilot/
    env_file:
      - .env.litellm
    command: [ "--config", "/app/config.yaml", "--port", "4141", "--num_workers", "8" ]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - litellm-network

  # Nginx reverse proxy for HTTPS termination
  # Note: This proxy expects app services to be accessible via host networking
  # Start app stack separately with: docker-compose -f chat2anyllm-app/docker-compose.yml up -d
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: litellm-nginx
    depends_on:
      - litellm
    ports:
      - "80:80"
      - "443:443"
      - "4142:4142"  # Dedicated TLS entrypoint for litellm
    volumes:
      - ./certs:/etc/nginx/certs:ro
      - ./nginx/default-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - litellm-network


volumes:
  postgres_data:

networks:
  litellm-network:
    driver: bridge
