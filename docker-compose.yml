services:
  # PostgreSQL database for LiteLLM
  postgres:
    build:
      context: .
      dockerfile: Dockerfile.postgres
    container_name: litellm-postgres
    env_file:
      - .env.postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - litellm-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U litellm -d litellm"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis cache for LiteLLM
  redis:
    build:
      context: .
      dockerfile: Dockerfile.redis
    container_name: litellm-redis
    networks:
      - litellm-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # LiteLLM proxy server (now exposed on host 4141)
  litellm:
    image: ${LITELLM_IMAGE}
    container_name: litellm-proxy
    ports:
      - "4141:4141"  # Expose LiteLLM directly on host for local access
    volumes:
      - ./config.yaml:/app/config.yaml # Mount the local configuration file
      - /home/jzhu/.config/litellm/github_copilot/:/root/.config/litellm/github_copilot/
    env_file:
      - .env.litellm
    command: [ "--config", "/app/config.yaml", "--port", "4141", "--num_workers", "8" ]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - litellm-network

  # Chat2AnyLLM frontend
  chat2anyllm-frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: chat2anyllm-frontend
    env_file:
      - .env.chat2anyllm-frontend
    ports:
      - "3000:3000"
    depends_on:
      - chat2anyllm-backend
    networks:
      - litellm-network

  # Nginx reverse proxy for frontend+backend+litellm (HTTPS termination)
  chat2anyllm-proxy:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: chat2anyllm-proxy
    depends_on:
      - chat2anyllm-frontend
      - chat2anyllm-backend
      - litellm
    ports:
      - "80:80"
      - "443:443"
      - "4142:4142"  # Expose new dedicated TLS entrypoint for litellm via nginx on host 4142
    volumes:
      - ./certs:/etc/nginx/certs:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - litellm-network

  # Chat2AnyLLM backend
  chat2anyllm-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: chat2anyllm-backend
    env_file:
      - .env.chat2anyllm-backend
    environment:
      - DATABASE_URL=postgresql://litellm:litellm@postgres:5432/chat2anyllm
    ports:
      - "3001:3001"
    depends_on:
      litellm:
        condition: service_started
      postgres:
        condition: service_healthy
    networks:
      - litellm-network

  # Open WebUI frontend
  openwebui:
    image: ghcr.nju.edu.cn/open-webui/open-webui:latest
    container_name: open-webui
    ports:
      - "8000:8080"
    volumes:
      - open-webui:/app/backend/data
    networks:
      - litellm-network
    depends_on:
      litellm:
        condition: service_started
      postgres:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  postgres_data:
  open-webui:

networks:
  litellm-network:
    driver: bridge
